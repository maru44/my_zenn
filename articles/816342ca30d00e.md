---
title: "é™çš„è§£æãƒ„ãƒ¼ãƒ«ä½œã£ãŸ"
emoji: "ğŸªº"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
---

é™çš„è§£æã§ package å†…ã§ type ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®æƒ…å ±ã‚’ã¾ã¨ã‚ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™
é™çš„è§£æã®éš›ã«å½¹ç«‹ã¤ã‹ã‚‚ï¼Ÿ
é™çš„è§£æã®éš›ã« struct ã® ã‚¿ã‚° ã¨ã‹ã‚³ãƒ¡ãƒ³ãƒˆã¨ã‹ã¾ã¨ã‚ã¦å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã¨æ¥½ã ãªãƒ¼ã¨æ€ã£ã¦ä½œã‚Šã¾ã—ãŸ

ä¼¼ãŸã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚ã‚Šãã†ã ã‹ã‚‰è»Šè¼ªã®å†ç™ºæ˜ã«ãªã£ã¦ã—ã¾ã£ãŸã‹ã‚‚...
é™çš„è§£æã®ç°¡å˜ãªå¾©ç¿’ã‚‚å…¼ã­ã¦ä½œã‚Šã¾ã—ãŸ
`go/types` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§äº‹è¶³ã‚Šã‚‹æ°—ã‚‚ã™ã‚‹...

ãŸã¶ã‚“è‰²ã€…è€ƒæ…®ã‚‚ã‚Œç­‰ã‚ã‚‹ã‘ã‚Œã©ä¸€æ—¦ãã‚Œã£ã½ãã§ããŸã®ã§ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸ

## ãƒ–ãƒ„ã¨ä½¿ã„æ–¹

https://github.com/maru44/stst

ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã€`golang.org/x/tools/go/packages.Package` ã‚’ NewParser ã«æ¸¡ã—ã¦ `*stst.Parser` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€`*stst.Parser` ã® `Parse` ã‚‚ã—ãã¯ `ParseFile` ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿè¡Œã€ `[]*stst.Schema` ãŒçµæœã¨ã—ã¦è¿”ã•ã‚Œã¾ã™

```go:example.go
package main

import (
	"fmt"

	"github.com/k0kubun/pp"
	"github.com/maru44/stst"
	"golang.org/x/tools/go/packages"
)

func main() {
	ps := loadPackages("github.com/maru44/stst/tests/data/aaa")

	var schemas []*stst.Schema
	for _, pk := range ps {
		p := stst.NewParser(pk)
		s := p.Parse()
		schemas = append(schemas, s...)
	}
	pp.Println(schemas)
}

func loadPackages(ps ...string) []*packages.Package {
	cfg := &packages.Config{
		Mode: packages.NeedName | packages.NeedFiles | packages.NeedSyntax | packages.NeedTypes | packages.NeedTypesInfo,
	}
	pkgs, err := packages.Load(cfg, ps...)
	if err != nil {
		panic(err)
	}
	return pkgs
}

```

çµæœã¯ã“ã‚“ãªæ„Ÿã˜ã®ãŒè¿”ã£ã¦ãã¾ã™

```go
schemas = []*stst.Schema{
  &stst.Schema{
    Name:   "Intf",
    Fields: []*stst.Field{
      &stst.Field{
        Name:                "Hello",
        Func:                &stst.Func{
          Args:    []*stst.Field{},
          Results: []*stst.Field{
            &stst.Field{
              Name: "string",
              Type: &stst.Type{
                Underlying: "string",
                TypeName:   "string",
              },
            },
          },
        },
      },
    },
    Type: &stst.Type{
      Underlying: "github.com/maru44/stst/tests/data/aaa.Intf",
      PkgID:    "github.com/maru44/stst/tests/data/aaa",
      PkgPlusName: "aaa.Intf",
      TypeName:   "Intf",
    },
    IsInterface:  true,
  },
  &stst.Schema{
    Name:   "IntSample",
    Type:   &stst.Type{
      Underlying: "int",
      TypeName:   "int",
    },
  },
  &stst.Schema{
    Name:   "Sample",
    Fields: []*stst.Field{
      &stst.Field{
        Name: "Str",
        Type: &stst.Type{
          Underlying: "string",
          TypeName:   "string",
        },
        Tags:                []*stst.Tag{
          &stst.Tag{
            Key:    "tag0",
            Values: []string{
              "xxx",
            },
            RawValue: "xxx",
          },
          &stst.Tag{
            Key:    "tag1",
            Values: []string{
              "yyy",
              "zzz",
            },
            RawValue: "yyy,zzz",
          },
        },
        Comment: []string{
          "// comment",
        },
      },
    },
    Type: &stst.Type{
      Underlying: "github.com/maru44/stst/tests/data/aaa.Sample",
      PkgID:    "github.com/maru44/stst/tests/data/aaa",
      PkgPlusName: "aaa.Sample",
      TypeName:   "Sample",
    },
  },
  &stst.Schema{
    Name:   "prefixes",
    Type:   &stst.Type{
      Underlying: "github.com/maru44/stst/tests/data/aaa.prefixes",
      PkgID:    "github.com/maru44/stst/tests/data/aaa",
      PkgPlusName: "aaa.prefixes",
      TypeName:   "prefixes",
    },
    TypePrefixes: []stst.TypePrefix{
      "[]",
      "*",
      "[]",
      "[]",
      "[]",
      "*",
    },
  },
}
```

## ã¾ã¨ã‚

:::message alert
type set ãŒè€ƒæ…®æ¼ã‚Œã—ã¦ã¾ã—ãŸ
:::

é™çš„è§£æã‚„ã£ã±ã‚ŠãŠã‚‚ã‚ã„ã§ã™ã­
éœ€è¦ã‚ã‚Œã°ä½¿ã£ã¦ãã ã•ã„ ğŸ™‡

ã‚‚ã—ã€ä¼¼ãŸã‚ˆã†ãªã‚‚ã£ã¨è‰¯ã„ãƒ„ãƒ¼ãƒ«ã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ ğŸ™‡
