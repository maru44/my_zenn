---
title: "ãƒ†ã‚¹ãƒˆå¯èƒ½ å€‹äººé–‹ç™ºã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£...ã®è£œè¶³"
emoji: "ğŸ¦§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£", "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£", "test"]
published: true
---

# å‰ç½®ã

:::message
10/10 æ›¸ãç›´ã—ã¾ã—ãŸã€‚
table drivenã«ã—ã¾ã—ãŸ
controllerã®ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ ã—ã¾ã—ãŸã€‚
:::



ã“ã¡ã‚‰ã®è¨˜äº‹ã®è£œè¶³è¨˜äº‹ã¨ãªã‚Šã¾ã™ã€‚

https://zenn.dev/maru44/articles/b9e07e91a0ea77

æ€ã£ã¦ã„ã‚‹ä»¥ä¸Šã«é•·ããªã‚Šãã†ã ã£ãŸã®ã§åˆ¥è¨˜äº‹ã¨ã—ã¾ã—ãŸã€‚
ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã¤ã„ã¦è¨€åŠã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¿ãªã•ã‚“ã¯ go ã§ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã©ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
æœ€è¿‘ ginkgo ã‚’ä½¿ç”¨ã—å§‹ã‚ã¾ã—ãŸã€‚
è‡ªåˆ†ã®æ€§æ ¼ã‚’è€ƒãˆã‚‹ã¨æœ€çµ‚çš„ã« testing ã‚ªãƒ³ãƒªãƒ¼ã«å›å¸°ã—ãã†ã§ã™ã€‚

ä»Šå›ã¯ã¨ã‚Šã‚ãˆãš assert ç”¨ã« testify ã‚’ DB ã®ãƒ¢ãƒƒã‚¯ã¨ã—ã¦ sqlmock ã‚’ä½¿ã£ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒ
table driven test
https://github.com/golang/go/wiki/TableDrivenTests

# ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

DB ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹å®Ÿå‡¦ç†ã®éƒ¨åˆ†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
MVC ã§è¨€ã†ã¨ models å±¤ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§è¨€ã†ã¨ãƒªãƒã‚¸ãƒˆãƒªå±¤ã«ãªã‚Šã¾ã™ã€‚

## MVC

```go:models/blog.go
package models

import (
    ".../connector"
)

// blogã®å®šç¾©
type TBlog struct {
    ID      int    `json:":id"`
    Title   string `json:"title"`
    Content string `json:"content"`
}

// å…¨æ¨©å–å¾—ã¯çœç•¥

// blogä¸€ä»¶å–å¾—
func BlogDetail(id int) (b []TBlog, err error) {
    db := connector.AccessDB()
    defer db.Close()

    rows, err := db.Query("SELECT * FROM blogs WHERE id = ?", id)
    rows.Next()
    err := rows.Scan(
        &b.ID, &b.Title, &b.Content,
    )
    return
}
```

å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã¯æ›¸ãã¾ã›ã‚“ãŒã€BlogDetail ã‚’ã»ã¨ã‚“ã©æ¨¡å†™ã™ã‚‹ã‚ˆã†ãªå½¢ã§ãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„ã®ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã‚ˆã­ã€‚
BlogDetail ã®å¼•æ•°ã«\*sql.DB ã®å‹ã®å¤‰æ•°ã‚’åŠ ãˆã‚Œã°å°‘ã—ã¯ãƒã‚·ã«ãªã‚Šã¾ã™ãŒã€ã€ã€ã£ã¦æ„Ÿã˜ã§ã™ã€‚

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ä¸€æ–¹ã§ã“ã¡ã‚‰ã¯ç°¡å˜ã§ã™ã€‚å°‘ã€…é¢å€’ãªã®ãŒã©ã†ã—ã¦ã‚‚ DB ã¨ã®ã‚„ã‚Šå–ã‚Šã®å±¤ãªã®ã§ DB ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ç‚¹ã§ã™ã€‚ã¾ã‚ã€ã“ã¡ã‚‰ã¯ MVC ã«ã‚‚å…±é€šã—ã¾ã™ã€‚

ã¾ãšã“ã¡ã‚‰ãŒãƒ†ã‚¹ãƒˆã®å¯¾è±¡ã«ãªã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```go:interfaces/database/blog_repository.go
package databse

import ".../domain"

// blog repositoryã¯SqlHandlerã‚’æ‰€æŒã™ã‚‹
type BlogRepository struct {
    SqlHandler
}

func (repo *BlogRepository) FindById(id int) (b []domain.TBlog, err error) {
    rows, err := repo.Query(
        "SELECT * from blogs WHERE id = ?", id,
    )
    defer rows.Close()

    rows.Next()
    err := rows.Scan(
        &b.ID, &b.Title, &b.Content,
    )
    return
}

```

ãƒ†ã‚¹ãƒˆç”¨ã«ãƒ€ãƒŸãƒ¼ SQL ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°ã‚’ä½œæˆã—ãŸä¸Šã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
è¦‹ã¦ã‚ã‹ã‚‹ã¨ãŠã‚Šã‘ã£ã“ã†é•·ãã¦å¤§å¤‰ã§ã™ã€‚

```go:interfaces/database/blog_repository_test.go
package database_test

import (
    ".../domain"
    ".../infrastructure"
    ".../interfaces/database"
    "database/sql"
    "regexp"
    "testing"

    "github.com/DATA-DOG/go-sqlmock"
    "github.com/stretchr/testify/assert"
)

// ãƒ€ãƒŸãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç”Ÿæˆé–¢æ•°
// ã©ã“ã‹é•ã†ã¨ã“ã§å®šç¾©ã—ã¦ä½¿ã„ã¾ã‚ã™æ–¹ãŒãŠå¾—
func newDummyHandler(db *sql.DB) database.SqlHandler {
    sqlHandler := new(infrastructure.SqlHandler)
    sqlHandler.Conn = db
    return sqlHandler
}

func TestFindBlogById(t *testing.T) {
    // table for test
    table := []struct {
        testName string
        id       int
        blog     domain.TBlog
        err      error
    } {
        {
            "success",
            30,
            domain.TBlog{
                ID:      30,
                Title:   "ãƒ–ãƒ­ã‚°ãã®30",
                Content: "ãƒ–ãƒ­ã‚°ã®æœ¬æ–‡\nä»Šæ—¥ã‚‚æ²¢å±±ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã—ãŸã€‚"
            },
            nil,
        },
    }

    /*   prepare   */
    db, mock, err := sqlmock.New()
    if err != nil {
        t.Error("sqlmock not work")
    }
    defer db.Close()

    repo := &database.ReviewRepository{
        SqlHandler: newDummyHandler(db)
    }

    query := "SELECT * from blogs WHERE id = ?"

    for _, tt := range table {
        t.Run(tt.testName, func(t *testing.T) {
            b := tt.blog
            rows := sqlmock.NewRows([]string{
                "id", "title", "content",
            }). AddRow(b.ID, b.Title, b.Content)
            mock.ExpectQuery(regexp.QuoteMeta(query)).WithArgs(tt.id).WillReturnRows(rows)

            got, err := repo.FindById(b.ID)

            assert.Equal(t, tt.err, err)
            assert.Equal(t, b, got)
        })
    }
}

```

# ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤ã®ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆå¯èƒ½ã§çœŸä¾¡ãŒç™ºæ®ã•ã‚Œã‚‹ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚

ãƒ†ã‚¹ãƒˆã®å¯¾è±¡ã¨ãªã‚‹ã®ã¯ã“ã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```go:usecase/blog_interactor.go
package usecase

import ".../domain"

type BlogInteractor struct {
	repository BlogRepository
}

func NewBlogInteractor(blog BlogRepository) domain.BlogInteractor {
	return &BlogInteractor{
		repository: blog,
	}
}

/************************
        repository
************************/

type BlogRepository interface {
	FindById(int) (domain.TBlog, error)
}

/**********************
   interactor methods
***********************/

func (interactor *BlogInteractor) DetailBlog(id int) (blog domain.TBlog, err error) {
        blog, er = interactor.repository.FindById(id)
	return
}

```

DetailBlog ã¨ã„ã†é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
ãƒ¢ãƒƒã‚¯ã¯ mock ã‚’ä½¿ã‚ãšã«æ‰‹ä½œã‚Šã—ã¾ã™ã€‚ã¨ã¦ã‚‚ç°¡å˜ã«ä½œã‚Œã¾ã™ã€‚

```go:usecase/blog_interactor_test.go
package usecase_test

import (
    ".../domain"
    ".../database"
    ".../usecase"
    "testing"

    "github.com/stretchr/testify/assert"
)

// BlogRepositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æº€ãŸã™fakeBlogRepositoryã‚’ä½œã‚‹
type blogRepository struct {
    database.BlogRepository
}

var (
    detailTable = []struct {
        testName string
        id       int
        blog     domain.TBlog
        err      error
    } {
        {
            "success",
            30,
            domain.TBlog{
                ID:      30,
                Title:   "ãƒ–ãƒ­ã‚°ãã®30",
                Content: "ãƒ–ãƒ­ã‚°ã®æœ¬æ–‡\nä»Šæ—¥ã‚‚æ²¢å±±ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã—ãŸã€‚"
            },
            nil,
        },
    }
)

// FindByIdãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã‚’å®šç¾©
func (repo *blogRepository) FindById(id int) (domain.TBlog, error) {
    for _, t := range detailTable {
        if r.id == id {
            return t.blog, nil
        }
    }
    return domain.TBlog{}, errors.New("not found")
}

// test
func TestDetailBlog(t *testing.T) {
    mockBlogRepo := new(blogRepository)
    interactor := usecase.NewBlogInteractor(mockBlogRepo)

    for _, tt := range detailTable {
        t.Run(tt.testName, func(t *testing.T) {
            b, err := interactor.DetailBlog(tt.id)

            assert.Equal(t, tt.err, err)
            assert.Equal(t, tt.blog, b)
        })
    }
}

```

ã“ã®ãƒ†ã‚¹ãƒˆã§ BlogInteractor ã® DetailBlog ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ãŸéš›ã«ã€BlogRepository ã® FindById ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ãŸã£ãŸã“ã‚Œã ã‘ã§ãƒ†ã‚¹ãƒˆãŒã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
éå¸¸ã«ç°¡å˜ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

# ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤(ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼)ã®ãƒ†ã‚¹ãƒˆ

ã“ã¡ã‚‰ã¯å°‘ã—ã‚„ã‚„ã“ã—ã„ã§ã™ã€‚
`httptest`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã‚ã¨è‡ªåˆ†ã®å ´åˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆã¯`<package_name>_test`ã§è¡Œã‚ãšã€`<package_name>`ã®ã¾ã¾ã‚„ã£ã¦ã„ã¾ã™ã€‚
ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªé–¢æ•°ç­‰ã‚’ä½¿ãˆãŸã‚Šã™ã‚‹ã®ã§ã€ã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ãªã‚‰ãªã„é™ã‚Šã“ã†ã—ãŸæ–¹ãŒä¾¿åˆ©ã§ã™ã€‚

```go:blog_controller_test.go
package controllers

import (
    ".../domain"
    ".../usecase"
    "testing"
    "net/http"
    "net/http/httptest"

    "github.com/stretchr/testify/assert"
)

type blogInteractor struct {
    usecase.BlogInteractor
}

// mock func

func (i *blogInteractor) DetailBlog(id int) (domain.TBlog, error) {
    return domain.TBlog{}, nil
}

func Test_DetailBlogView(t *testing.T) {
    con := BlogController{
        interactor: &blogInteractor{},
    }

    table := []struct{
        testName   string
        id         int
        wantStatus int
    } {
        {
            "success01",
            20,
            200,
        },
    }

    for _, tt := range table {
        t.Run(tt.testName, func(t *testing.T) {
            r := httptest.NewRequest(http.MethodGet, "https://abc/def", nil)

            qs := r.URL.Query()
            qs.Add("id", string(tt.id))
            r.URL.RawQuery = qs.Encode()

            got := httptest.NewDecoder()

            con.DetailBlogView(got, r)
            assert.Equal(t, tt.wantStatus, got.Result().StatusCode)
        })
    }
}

```

tableã‚’ãƒ†ã‚¹ãƒˆé–¢æ•°ã®å¤–ã§å®šç¾©ã™ã‚Œã°DetailBlogã§ã‚ãƒ¼ã ã“ãƒ¼ã å ´åˆåˆ†ã‘ã‚’æ›¸ãã“ã¨ã§ã€éæ­£å¸¸ã‚‚ãƒªãƒƒãƒã«å¯¾å¿œã§ãã¾ã™ã€‚

## å°æŠ€

### context
http.Requestã®contextã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDç­‰ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å‡¦ç†ã¯æ²¢å±±ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã†ã„ã†éš›ã«ã‚‚
```go
ctx := context.WithValue(
    r.Context(),
    USER_ID,
    userId,
)
r = r.WithContext(ctx)
```
ã®ç”¨ã«ã‚„ã£ã¦ã‚ã’ã‚Œã°contextã«å¿…è¦ãªå€¤ã‚’ä¸ãˆãŸä¸Šã§ãƒ†ã‚¹ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚
ã“ã®contextã¸ã®ã‚»ãƒƒãƒˆã¯ãƒ†ã‚¹ãƒˆã˜ã‚ƒãªã„éƒ¨åˆ†ã§ã‚‚ä½¿ãˆã‚‹ã®ã§é–¢æ•°ã¨ã—ã¦æŠœãå‡ºã—ã¦ãŠãã¹ãã§ã—ã‚‡ã†ã€‚

### jsonã®ãƒã‚¹ãƒˆ
jsonã®ãƒã‚¹ãƒˆã‚‚ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
```go
t.Run(tt.testName, func(t *testing.T) {
    json_, err := json.Marshal(tt.input)
    if err != nil {
		t.Fatal(err)
	}

    r := httptest.NewRequest(http.MethodPost, "https://abc/def/post", bytes.NewBuffer(json_))
    r = setUserToContext(r, tt.userId)

    got := httptest.NewDecoder()
    con.DetailBlogView(got, r)
    assert.Equal(t, tt.wantStatus, got.Result().StatusCode)
})
```

# ã¾ã¨ã‚

å°‘ã—å¦¥å”ã—ã¦ã—ã¾ã£ãŸã®ã§ã¡ã‚ƒã‚“ã¨ã—ãŸæ¯”è¼ƒã«ãªã£ã¦ãªã„ç‚¹ã¯ã™ã„ã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«ã€ã‹ã¤éå¸¸ã«ã‚¯ãƒªãƒ¼ãƒ³ã«æ›¸ã‘ã‚‹ã“ã¨ãŒä¼ã‚ã£ã¦ãã‚Œã‚Œã°ã†ã‚Œã—ã„ã§ã™ã€‚

å…¨ä½“ã¨ã—ã¦ `assert.NoError` ã‚’ä½¿ã‚ãªã„ã®ã¯ã‚¨ãƒ©ãƒ¼ã‚’éæ­£å¸¸ç³»ã‚‚ä¸€ç·’ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ†ã‚¹ãƒˆå¯èƒ½

æŠ½è±¡(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)ã‚’å‚ç…§ã—ã¦ã„ã‚‹(ã«ä¾å­˜ã—ã¦ã„ã‚‹)ãŸã‚å®Ÿè£…ã‚’ç°¡å˜ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ãŸã‚ãƒ†ã‚¹ãƒˆãŒéå¸¸ã«ç°¡å˜ã§ã™ã€‚

å±¤ã”ã¨ã«ãƒ†ã‚¹ãƒˆã®ç›®çš„ã‚’æ˜ç¢ºã«ã—ãŸã†ãˆã§ãƒ†ã‚¹ãƒˆã§ãã‚‹
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ä¾å­˜å…ˆã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã ã‘ã§ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹
ä¾å­˜é–¢ä¿‚ãŒæ•´ç†ã•ã‚Œã¦ãŠã‚Šãƒ†ã‚¹ãƒˆãŒæœ¬ç•ªã®å‡¦ç†ã¨ã¯åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
